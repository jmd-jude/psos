// schema.prisma

datasource db {
  provider = "sqlite"
  url      = "file:./prisma/psos.db"
}

generator client {
  provider = "prisma-client-js"
}

model UseCase {
  id               String    @id @default(cuid())
  name             String
  description      String?   // Product marketing description (1-2 sentences)
  buyerOutcome     String?   @map("buyer_outcome")
  dataInputs       String?   @map("data_inputs")
  dataOutputs      String?   @map("data_outputs")
  limitations      String?
  competitiveNotes String?   @map("competitive_notes")
  status           String    @default("Active") // Active, Under Review, Deprecated
  owner            String?
  lastReviewed     DateTime? @map("last_reviewed")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  verticals             UseCaseVertical[]
  categories            UseCaseCategory[]
  deliveryMechanisms    UseCaseDeliveryMechanism[]
  capabilityAssessments UseCaseCapabilityAssessment[]
  opportunityScores     OpportunityScore[]

  @@map("use_cases")
}

model Vertical {
  id                      String   @id @default(cuid())
  name                    String   @unique
  description             String?
  keyBuyerPersona         String?  @map("key_buyer_persona")
  primaryPainPoint        String?  @map("primary_pain_point")
  complianceConsiderations String? @map("compliance_considerations")
  strategicPriority       String   @default("Medium") // Critical, High, Medium, Low
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  useCases UseCaseVertical[]

  @@map("verticals")
}

model UseCaseVertical {
  id         String   @id @default(cuid())
  useCaseId  String   @map("use_case_id")
  verticalId String   @map("vertical_id")
  fit        String   @default("Primary") // Primary, Secondary

  useCase  UseCase  @relation(fields: [useCaseId], references: [id], onDelete: Cascade)
  vertical Vertical @relation(fields: [verticalId], references: [id], onDelete: Cascade)

  @@unique([useCaseId, verticalId])
  @@map("use_case_verticals")
}

model OpportunityScore {
  id                 String   @id @default(cuid())
  useCaseId          String   @map("use_case_id")

  // --- BUSINESS GROWTH METRICS (existing) ---
  arrRaw             Float?   @map("arr_raw")
  arrScore           Int?     @map("arr_score") // 1-5
  pipelineRaw        Float?   @map("pipeline_raw")
  pipelineScore      Int?     @map("pipeline_score")
  velocityRaw        Float?   @map("velocity_raw") // days
  velocityScore      Int?     @map("velocity_score")
  winRateRaw         Float?   @map("win_rate_raw") // 0-1
  winRateScore       Int?     @map("win_rate_score")
  strategicFitScore  Int?     @map("strategic_fit_score")

  // --- PRODUCT PERFORMANCE METRICS (new) ---
  matchRateImpact    Float?   @map("match_rate_impact")     // Expected improvement as decimal (0.07 = 7%)
  matchRateScore     Int?     @map("match_rate_score")      // 1-5
  latencyRequirement String?  @map("latency_requirement")   // 'real-time' | 'near-real-time' | 'batch'
  latencyScore       Int?     @map("latency_score")         // 1-5
  privacyRiskLevel   String?  @map("privacy_risk_level")    // 'high' | 'medium' | 'low'
  privacyRiskScore   Int?     @map("privacy_risk_score")    // 1-5 (low risk=5, high risk=1)
  dataSourceDepends  String?  @map("data_source_depends")   // Comma-separated list
  dataSourceScore    Int?     @map("data_source_score")     // 1-5 (fewer=5, many=1)
  scaleRequirement   String?  @map("scale_requirement")     // 'full-graph' | 'subset' | 'sample'
  scaleScore         Int?     @map("scale_score")           // 1-5

  // --- METADATA ---
  sourceNotes        String?  @map("source_notes")
  scoredBy           String?  @map("scored_by")
  scoreDate          DateTime @default(now()) @map("score_date")

  useCase UseCase @relation(fields: [useCaseId], references: [id], onDelete: Cascade)

  @@map("opportunity_scores")
}

model Glossary {
  id          String   @id @default(cuid())
  term        String
  abbreviation String?
  definition  String
  context     String?
  category    String   // Identity & Data, Platform & Technology, Compliance & Privacy, Company Delivery
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("glossary")
}

model AIInsight {
  id          String   @id @default(cuid())
  insightType String   @map("insight_type") // use_case_analysis, comparison, gap_analysis, quarterly_review
  inputData   String   @map("input_data") // JSON of input parameters
  prompt      String
  response    String
  useCaseId   String?  @map("use_case_id") // optional link to use-case
  createdAt   DateTime @default(now()) @map("created_at")
  createdBy   String?  @map("created_by")

  @@map("ai_insights")
}

// Company-level capabilities that use cases inherit by default
model CompanyCapability {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?  // What this capability measures
  score       Int      // 1-5
  rationale   String?  // Why this score
  sortOrder   Int      @default(0) @map("sort_order")
  lastUpdated DateTime @updatedAt @map("last_updated")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relation to use case assessments
  useCaseMaturity UseCaseCapabilityAssessment[]

  @@map("company_capabilities")
}

// Use case capability assessments with inherit/override pattern
model UseCaseCapabilityAssessment {
  id                String   @id @default(cuid())
  useCaseId         String   @map("use_case_id")
  capabilityId      String   @map("capability_id")

  // Inherit vs Override pattern
  useCompanyScore   Boolean  @default(true) @map("use_company_score")
  overrideScore     Int?     @map("override_score") // 1-5, only if useCompanyScore = false
  overrideRationale String?  @map("override_rationale") // Required if overriding

  assessedDate      DateTime @default(now()) @map("assessed_date")
  assessedBy        String?  @map("assessed_by")

  useCase    UseCase            @relation(fields: [useCaseId], references: [id], onDelete: Cascade)
  capability CompanyCapability  @relation(fields: [capabilityId], references: [id], onDelete: Cascade)

  @@unique([useCaseId, capabilityId])
  @@map("use_case_capability_assessments")
}

// Categories: Functional classifications for use cases
model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  useCases UseCaseCategory[]

  @@map("categories")
}

// Many-to-many join table for use cases and categories
model UseCaseCategory {
  id         String   @id @default(cuid())
  useCaseId  String   @map("use_case_id")
  categoryId String   @map("category_id")

  useCase  UseCase  @relation(fields: [useCaseId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([useCaseId, categoryId])
  @@map("use_case_categories")
}

// Delivery Mechanisms: How use cases are delivered to customers
model DeliveryMechanism {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  useCases UseCaseDeliveryMechanism[]

  @@map("delivery_mechanisms")
}

// Many-to-many join table for use cases and delivery mechanisms
model UseCaseDeliveryMechanism {
  id                  String   @id @default(cuid())
  useCaseId           String   @map("use_case_id")
  deliveryMechanismId String   @map("delivery_mechanism_id")

  useCase           UseCase           @relation(fields: [useCaseId], references: [id], onDelete: Cascade)
  deliveryMechanism DeliveryMechanism @relation(fields: [deliveryMechanismId], references: [id], onDelete: Cascade)

  @@unique([useCaseId, deliveryMechanismId])
  @@map("use_case_delivery_mechanisms")
}
